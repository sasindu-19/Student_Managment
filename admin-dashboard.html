<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0a0b1a;
            background: radial-gradient(circle at top left, #1a1f4d 0%, #0a0b1a 50%),
                        radial-gradient(circle at bottom right, #1a1f4d 0%, #0a0b1a 50%);
            color: rgba(255, 255, 255, 0.9);
            min-height: 100vh;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 3rem;
            color: white;
            text-align: center;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            padding-left: 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            margin: 0.3rem 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item i {
            margin-right: 1rem;
        }

        .logout-btn {
            margin-top: auto;
            background: rgba(255, 59, 59, 0.1);
            color: rgb(255, 59, 59);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 59, 59, 0.2);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            width: 300px;
            color: white;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-change {
            font-size: 0.9rem;
            color: #4ade80;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            height: 400px;
        }

        /* Activity Table */
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
        }

        .activity-table th, .activity-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .activity-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 500;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            background: rgba(79, 70, 229, 0.1);
            color: #818cf8;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #0f1122;
            padding: 2rem;
            border-radius: 16px;
            width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #818cf8;
            color: white;
            transition: all 0.3s ease;
        }

        button[type="button"] {
            background: rgba(255, 255, 255, 0.1);
        }

        button:hover {
            opacity: 0.9;
        }

        .add-btn {
            background: #4ade80;
        }

    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">StudentMS</div>
            
            <!-- Dashboard Section -->
            <div class="nav-section">
                <div class="nav-section-title">Dashboard</div>
                <div class="nav-item active">üìä Overview</div>
            </div>

            <!-- View Section -->
            <div class="nav-section">
                <div class="nav-section-title">View</div>
                <div class="nav-item">üë§ View Admins</div>
                <div class="nav-item">üë®‚Äçüè´ View Teachers</div>
                <div class="nav-item">üë• View Students</div>
                <div class="nav-item">üìö View Courses</div>
            </div>

            <!-- Add Section -->
            <div class="nav-section">
                <div class="nav-section-title">Manage</div>
                <div class="nav-item">‚ûï Add Admin</div>
                <div class="nav-item">‚ûï Add Teacher</div>
                <div class="nav-item">‚ûï Add Student</div>
                <div class="nav-item">‚ûï Add Course</div>
            </div>

            <!-- Settings -->
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item">‚öôÔ∏è Settings</div>
            </div>

            <!-- Logout Button -->
            <div class="logout-btn">
                üö™ Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <input type="text" class="search-bar" placeholder="Search...">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <span>Admin</span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Total Admins</div>
                    <div class="card-value" id="total-admins">Loading...</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Teachers</div>
                    <div class="card-value" id="total-teachers">Loading...</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Students</div>
                    <div class="card-value" id="total-students">Loading...</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Courses</div>
                    <div class="card-value" id="total-courses">Loading...</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="enrollmentChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="gradesChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Admin (John)</td>
                        <td>Added Teacher</td>
                        <td>Dr. Sarah Wilson</td>
                        <td>Today, 2:30 PM</td>
                        <td><span class="status-badge">Completed</span></td>
                    </tr>
                    <tr>
                        <td>System</td>
                        <td>New Enrollment</td>
                        <td>15 Students - Data Science</td>
                        <td>Today, 1:45 PM</td>
                        <td><span class="status-badge">New</span></td>
                    </tr>
                    <tr>
                        <td>Admin (Mike)</td>
                        <td>Added Course</td>
                        <td>Advanced Web Development</td>
                        <td>Today, 11:20 AM</td>
                        <td><span class="status-badge">Active</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
<script type="module">
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBQN5VVmW0eCGfJ7CR88yKdUVVniCQxvY8",
        authDomain: "studentregistration-fde69.firebaseapp.com",
        databaseURL: "https://studentregistration-fde69-default-rtdb.firebaseio.com",
        projectId: "studentregistration-fde69",
        storageBucket: "studentregistration-fde69.firebasestorage.app",
        messagingSenderId: "247451311801",
        appId: "1:247451311801:web:d3119255c9763728990568",
        measurementId: "G-SB7HB4Q15K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ‚úÖ FIX: Correct way to create Firebase Database Reference
    const databaseRef = ref(database, "students");
    const adminRef = ref(database, "Admins");
    const teacherRef = ref(database, "Teachers");
    const courseRef = ref(database, "Courses");


    // Function to get student count
    function getStudentCount() {
        onValue(databaseRef, (snapshot) => {
            let totalStudents = 0;
            snapshot.forEach((groupSnapshot) => {
                totalStudents += groupSnapshot.size; // ‚úÖ FIX: 'size' instead of 'numChildren()'
            });
            document.getElementById("total-students").innerText = totalStudents;
        }, (error) => {
            document.getElementById("total-students").innerText = "Error fetching data";
            console.error("Firebase Error:", error.message);
        });
    }

    // Function to get admin count
    function getAdminCount() {
        onValue(adminRef, (snapshot) => {
            const keysCount = snapshot.size; // ‚úÖ Get the number of children
            document.getElementById("total-admins").innerText = keysCount;
        }, (error) => {
            document.getElementById("total-admins").innerText = "Error fetching data";
            console.error("Firebase Error:", error.message);
        });
    }

    // Function to get teacher count
    function getTeacherCount() {
        onValue(teacherRef, (snapshot) => {
            const keysCount = snapshot.size; // ‚úÖ Get the number of children
            document.getElementById("total-teachers").innerText = keysCount;
        }, (error) => {
            document.getElementById("total-teachers").innerText = "Error fetching data";
            console.error("Firebase Error:", error.message);
        });
    }

    // Function to get course count
    function getCourseCount() {
        onValue(courseRef, (snapshot) => {
            const keysCount = snapshot.size; // ‚úÖ Get the number of children
            document.getElementById("total-courses").innerText = keysCount;
        }, (error) => {
            document.getElementById("total-courses").innerText = "Error fetching data";
            console.error("Firebase Error:", error.message);
        });
    }

    // Call the function when the page loads
    getCourseCount();
    getStudentCount();
    getAdminCount();
    getTeacherCount();

    document.addEventListener('DOMContentLoaded', () => {
        // Enrollment Chart
        const enrollmentCtx = document.getElementById('enrollmentChart').getContext('2d');
        new Chart(enrollmentCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Student Enrollment',
                    data: [650, 800, 950, 1100, 1200, 1234],
                    borderColor: '#818cf8',
                    backgroundColor: 'rgba(129, 140, 248, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)'
                        }
                    }
                }
            }
        });

        // Grades Chart
        const gradesCtx = document.getElementById('gradesChart').getContext('2d');
        new Chart(gradesCtx, {
            type: 'doughnut',
            data: {
                labels: ['A', 'B', 'C', 'D'],
                datasets: [{
                    data: [45, 30, 15, 10],
                    backgroundColor: [
                        '#818cf8',
                        '#4ade80',
                        '#facc15',
                        '#f87171'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.6)'
                        }
                    }
                }
            }
        });

        // Animation for page elements
        gsap.from('.sidebar', {
            duration: 1,
            x: -100,
            opacity: 0,
            ease: 'power3.out'
        });

        gsap.from('.charts-grid .chart-container', {
            duration: 0.8,
            y: 50,
            opacity: 0,
            stagger: 0.2,
            delay: 0.4,
            ease: 'power3.out'
        });

        gsap.from('.activity-table', {
            duration: 0.8,
            y: 50,
            opacity: 0,
            delay: 0.6,
            ease: 'power3.out'
        });

// Add click event listeners for navigation
document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                // Add active class to clicked item
                this.classList.add('active');
                
                // Handle navigation logic
                const itemText = this.textContent.trim();
                handleNavigation(itemText);
            });
        });

        // Logout button functionality
        document.querySelector('.logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                // Add your logout logic here
                window.location.href = 'index.html'; 
            }
        });

        // Handle navigation function
        function handleNavigation(navItem) {
            // Store the main content area
            const mainContent = document.querySelector('.main-content');
            
            switch(navItem) {
                case 'üìä Overview':
                    loadOverviewView();
                    break;
                    
                case 'üë§ View Admins':
                    loadAdminView();
                    break;
                    
                case 'üë®‚Äçüè´ View Teachers':
                    loadTeacherView();
                    break;
                    
                case 'üë• View Students':
                    loadStudentView();
                    break;
                    
                case 'üìö View Courses':
                    loadCourseView();
                    break;
                    
                case '‚ûï Add Admin':
                    showAddAdminForm();
                    break;
                    
                case '‚ûï Add Teacher':
                    showAddTeacherForm();
                    break;
                    
                case '‚ûï Add Student':
                    showAddStudentForm();
                    break;
                    
                case '‚ûï Add Course':
                    showAddCourseForm();
                    break;
                    
                case '‚öôÔ∏è Settings':
                    loadSettings();
                    break;
            }
        }
        
        function loadOverviewView(){
            window.location.href = "admin-dashboard.html";
        }
        // View loading functions
        function loadAdminView() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h2>Manage Administrators</h2>
                    <button class="add-btn" onclick="showAddAdminForm()">Add New Admin</button>
                </div>
                <div class="table-container">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>NIC</th>
                                <th>Address</th>
                                <th>DOB</th>
                                <th>Phone</th>
                                <th>Gender</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody">
                            <!-- Admin data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            `;
            loadAdminData();
        }
    // ‚úÖ Initialize Firebase
    const auth = getAuth(app);

    // ‚úÖ Function to Load Admin Data
    function loadAdminData() {
    const adminTableBody = document.getElementById("adminTableBody");
    const adminRef = ref(database, "Admins");

    onValue(adminRef, (snapshot) => {
        adminTableBody.innerHTML = ""; // Clear table before adding new data

        snapshot.forEach((childSnapshot) => {
            const admin = childSnapshot.val();
            const adminId = childSnapshot.key;

            // Create table row
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${admin.name}</td>
                <td>${admin.nic || "N/A"}</td>
                <td>${admin.address || "N/A"}</td>
                <td>${admin.dob || "N/A"}</td>
                <td>${admin.phone || "N/A"}</td>
                <td>${admin.gender || "N/A"}</td>
                <td>
                    <button class="edit-btn" data-id="${adminId}">Edit</button>
                </td>
            `;

            adminTableBody.appendChild(row);
        });

        // ‚úÖ Attach event listeners to edit and delete buttons after rows are added
        document.querySelectorAll(".edit-btn").forEach((button) => {
            button.addEventListener("click", function () {
                const adminId = this.getAttribute("data-id");
                editAdmin(adminId);
            });
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
            button.addEventListener("click", function () {
                const adminId = this.getAttribute("data-id");
                deleteAdmin(adminId);
            });
        });
    }, (error) => {
        console.error("Firebase Error:", error.message);
    });
}
// ‚úÖ Function to edit an admin
function editAdmin(adminId) {
    const adminRef = ref(database, `Admins/${adminId}`);
    
    // Get current admin data
    get(adminRef).then((snapshot) => {
        const admin = snapshot.val();
        
        // Create and show edit form
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
            <div class="header">
                <h2>Edit Administrator</h2>
                <button class="back-btn" onclick="loadAdminView()">Back to List</button>
            </div>
            <div class="form-container">
                <form id="editAdminForm" class="admin-form">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" value="${admin.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="nic">NIC:</label>
                        <input type="text" id="nic" value="${admin.nic || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address:</label>
                        <textarea id="address" required>${admin.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth:</label>
                        <input type="text" id="dob" value="${admin.dob || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone:</label>
                        <input type="tel" id="phone" value="${admin.phone || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <select id="gender" required>
                            <option value="Male" ${admin.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${admin.gender === 'Female' ? 'selected' : ''}>Female</option>
                            <option value="Other" ${admin.gender === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" value="${admin.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="password">New Password (leave blank to keep current):</label>
                        <input type="password" id="password">
                    </div>
                    <button type="submit" class="submit-btn">Update Administrator</button>
                </form>
            </div>
        `;

        // Add submit handler for the edit form
        const editForm = document.getElementById('editAdminForm');
        editForm.onsubmit = (e) => {
            e.preventDefault();
            updateAdmin(adminId, admin.email); // Pass current email for comparison
        };
    }).catch((error) => {
        console.error("Error loading administrator data:", error);
        alert('Failed to load administrator data for editing');
    });
}

// Function to update admin data
async function updateAdmin(adminId, currentEmail) {
    const updatedAdmin = {
        name: document.getElementById('name').value,
        nic: document.getElementById('nic').value,
        address: document.getElementById('address').value,
        dob: document.getElementById('dob').value,
        phone: document.getElementById('phone').value,
        gender: document.getElementById('gender').value,
        email: document.getElementById('email').value
    };

    const newPassword = document.getElementById('password').value;
    const adminRef = ref(database, `Admins/${adminId}`);

    try {
        // Update admin data in database
        await update(adminRef, updatedAdmin);

        // If email changed, update authentication
        if (currentEmail !== updatedAdmin.email) {
            const user = auth.currentUser;
            if (user) {
                await updateEmail(user, updatedAdmin.email);
            }
        }

        // If new password provided, update it
        if (newPassword) {
            const user = auth.currentUser;
            if (user) {
                await updatePassword(user, newPassword);
            }
        }

        alert('Administrator updated successfully!');
        loadAdminView(); // Return to the admin list view
    } catch (error) {
        console.error("Error updating administrator:", error);
        alert('Failed to update administrator: ' + error.message);
    }
}
function loadTeacherView() {
    const mainContent = document.querySelector(".main-content");
    mainContent.innerHTML = `
        <div class="header">
            <h2>Manage Teachers</h2>
            <button class="add-btn" onclick="showAddTeacherForm()">Add New Teacher</button>
        </div>
        <div class="table-container">
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>NIC</th>
                        <th>Address</th>
                        <th>DOB</th>
                        <th>Phone</th>
                        <th>Gender</th>
                        <th>Course</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="teacherTableBody">
                    <!-- Teacher data will be loaded here -->
                </tbody>
            </table>
        </div>
    `;
    loadTeacherData();
}

function loadTeacherData() {
    const teacherTableBody = document.getElementById("teacherTableBody");
    const teacherRef = ref(database, "Teachers");

    onValue(
        teacherRef,
        (snapshot) => {
            teacherTableBody.innerHTML = ""; // Clear table before adding new data

            snapshot.forEach((childSnapshot) => {
                const teacher = childSnapshot.val(); // Get teacher data
                const teacherId = childSnapshot.key; // Get Firebase key

                // Create table row with teacher details
                const row = `
                    <tr>
                        <td>${teacher.name}</td>
                        <td>${teacher.nic || "N/A"}</td>
                        <td>${teacher.address || "N/A"}</td>
                        <td>${teacher.dob || "N/A"}</td>
                        <td>${teacher.phone || "N/A"}</td>
                        <td>${teacher.gender || "N/A"}</td>
                        <td>${teacher.course || "N/A"}</td>
                        <td>
                            <button class="edit-btn" data-id="${teacherId}">Edit</button>
                            <button class="delete-btn" data-id="${teacherId}">Delete</button>
                        </td>
                    </tr>
                `;

                teacherTableBody.innerHTML += row;
            });

            // Add event listeners after rows are inserted
            document.querySelectorAll(".edit-btn").forEach((button) => {
                button.addEventListener("click", function () {
                    const teacherId = this.getAttribute("data-id");
                    editTeacher(teacherId);
                });
            });

            document.querySelectorAll(".delete-btn").forEach((button) => {
                button.addEventListener("click", function () {
                    const teacherId = this.getAttribute("data-id");
                    deleteTeacher(teacherId);
                });
            });
        },
        (error) => {
            console.error("Firebase Error:", error.message);
        }
    );
}

function deleteTeacher(teacherId) {
    if (confirm('Are you sure you want to delete this teacher?')) {
        const teacherRef = ref(database, `Teachers/${teacherId}`);
        remove(teacherRef)
            .then(() => {
                alert('Teacher deleted successfully!');
            })
            .catch((error) => {
                console.error("Error deleting teacher:", error);
                alert('Failed to delete teacher');
            });
    }
}

// Function to show edit form with current teacher data
function editTeacher(teacherId) {
    const teacherRef = ref(database, `Teachers/${teacherId}`);
    
    // Get current teacher data
    get(teacherRef).then((snapshot) => {
        const teacher = snapshot.val();
        
        // Create and show edit form
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
            <div class="header">
                <h2>Edit Teacher</h2>
                <button class="back-btn" onclick="loadTeacherView()">Back to List</button>
            </div>
            <div class="form-container">
                <form id="editTeacherForm" class="teacher-form">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" value="${teacher.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="nic">NIC:</label>
                        <input type="text" id="nic" value="${teacher.nic || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address:</label>
                        <textarea id="address" required>${teacher.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth:</label>
                        <input type="text" id="dob" value="${teacher.dob || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone:</label>
                        <input type="tel" id="phone" value="${teacher.phone || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <select id="gender" required>
                            <option value="Male" ${teacher.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${teacher.gender === 'Female' ? 'selected' : ''}>Female</option>
                            <option value="Other" ${teacher.gender === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="course">Course:</label>
                        <input type="text" id="course" value="${teacher.course || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" value="${teacher.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="password">New Password (leave blank to keep current):</label>
                        <input type="password" id="password">
                    </div>
                    <button type="submit" class="submit-btn">Update Teacher</button>
                </form>
            </div>
        `;

        // Add submit handler for the edit form
        const editForm = document.getElementById('editTeacherForm');
        editForm.onsubmit = (e) => {
            e.preventDefault();
            updateTeacher(teacherId, teacher.email);
        };
    }).catch((error) => {
        console.error("Error loading teacher data:", error);
        alert('Failed to load teacher data for editing');
    });
}

// Function to update teacher data
async function updateTeacher(teacherId, currentEmail) {
    const updatedTeacher = {
        name: document.getElementById('name').value,
        nic: document.getElementById('nic').value,
        address: document.getElementById('address').value,
        dob: document.getElementById('dob').value,
        phone: document.getElementById('phone').value,
        gender: document.getElementById('gender').value,
        course: document.getElementById('course').value,
        email: document.getElementById('email').value
    };

    const newPassword = document.getElementById('password').value;
    const teacherRef = ref(database, `Teachers/${teacherId}`);

    try {
        // Update teacher data in database
        await update(teacherRef, updatedTeacher);

        // If email changed, update authentication
        if (currentEmail !== updatedTeacher.email) {
            const user = auth.currentUser;
            if (user) {
                await updateEmail(user, updatedTeacher.email);
            }
        }

        // If new password provided, update it
        if (newPassword) {
            const user = auth.currentUser;
            if (user) {
                await updatePassword(user, newPassword);
            }
        }

        alert('Teacher updated successfully!');
        loadTeacherView(); // Return to the teacher list view
    } catch (error) {
        console.error("Error updating teacher:", error);
        alert('Failed to update teacher: ' + error.message);
    }
}
        function loadStudentView() {
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
            <div class="header">
                <h2>Manage Student</h2>
                <button class="add-btn" onclick="showAddStudentForm()">Add New Student</button>
            </div>
            <div class="table-container">
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>NIC</th>
                            <th>Address</th>
                            <th>DOB</th>
                            <th>Phone</th>
                            <th>Gender</th>
                            <th>Course</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- Student data will be loaded here -->
                    </tbody>
                </table>
            </div>
        `;
        loadStudentData();
    }

    function loadStudentData() {
    const studentTableBody = document.getElementById('studentTableBody');
    const studentsRef = ref(database, "students");

    onValue(studentsRef, (snapshot) => {
        studentTableBody.innerHTML = ""; // Clear existing data
        snapshot.forEach((groupSnapshot) => { // Iterate through groups
            groupSnapshot.forEach((studentSnapshot) => { // Iterate through students in group
                const student = studentSnapshot.val();
                const groupId = groupSnapshot.key;
                const studentId = studentSnapshot.key;

                // Create table row with student details
                const row = `
                    <tr data-group-id="${groupId}" data-student-id="${studentId}">
                        <td>${student.name || "N/A"}</td>
                        <td>${student.nic || "N/A"}</td>
                        <td>${student.address || "N/A"}</td>
                        <td>${student.dob || "N/A"}</td>
                        <td>${student.phone || "N/A"}</td>
                        <td>${student.gender || "N/A"}</td>
                        <td>${student.course || "N/A"}</td>
                        <td>
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn">Delete</button>
                        </td>
                    </tr>
                `;
                studentTableBody.innerHTML += row;
            });
        });

        // Add event listeners for Edit and Delete buttons using event delegation
        studentTableBody.addEventListener('click', (event) => {
            const target = event.target;
            const row = target.closest('tr'); // Get the closest row to the clicked button
            if (!row) return;

            const groupId = row.dataset.groupId;
            const studentId = row.dataset.studentId;

            if (target.classList.contains('edit-btn')) {
                editStudent(groupId, studentId);
            } else if (target.classList.contains('delete-btn')) {
                deleteStudent(groupId, studentId);
            }
        });
    }, (error) => {
        console.error("Firebase Error:", error.message);
        alert("Failed to load student data");
    });
}
// Function to delete a student
function deleteStudent(groupId, studentId) {
    if (confirm('Are you sure you want to delete this student?')) {
        const studentRef = ref(database, `students/${groupId}/${studentId}`);
        remove(studentRef)
            .then(() => {
                alert('Student deleted successfully!');
            })
            .catch((error) => {
                console.error("Error deleting student:", error);
                alert('Failed to delete student');
            });
    }
}

// Function to show edit form with current student data
function editStudent(groupId, studentId) {
    const studentRef = ref(database, `students/${groupId}/${studentId}`);
    
    // Get current student data
    get(studentRef).then((snapshot) => {
        const student = snapshot.val();
        
        // Create and show edit form
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
            <div class="header">
                <h2>Edit Student</h2>
                <button class="back-btn" onclick="loadStudentView()">Back to List</button>
            </div>
            <div class="form-container">
                <form id="editStudentForm" class="student-form">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" value="${student.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="nic">NIC:</label>
                        <input type="text" id="nic" value="${student.nic || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address:</label>
                        <textarea id="address" required>${student.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth:</label>
                        <input type="text   " id="dob" value="${student.dob || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone:</label>
                        <input type="tel" id="phone" value="${student.phone || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <select id="gender" required>
                            <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                            <option value="Other" ${student.gender === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="course">Course:</label>
                        <input type="text" id="course" value="${student.course || ''}" required>
                    </div>
                    <button type="submit" class="submit-btn">Update Student</button>
                </form>
            </div>
        `;

        // Add submit handler for the edit form
        const editForm = document.getElementById('editStudentForm');
        editForm.onsubmit = (e) => {
            e.preventDefault();
            updateStudent(groupId, studentId);
        };
    }).catch((error) => {
        console.error("Error loading student data:", error);
        alert('Failed to load student data for editing');
    });
}

// Function to update student data
function updateStudent(groupId, studentId) {
    const updatedStudent = {
        name: document.getElementById('name').value,
        nic: document.getElementById('nic').value,
        address: document.getElementById('address').value,
        dob: document.getElementById('dob').value,
        phone: document.getElementById('phone').value,
        gender: document.getElementById('gender').value,
        course: document.getElementById('course').value
    };

    const studentRef = ref(database, `students/${groupId}/${studentId}`);
    
    update(studentRef, updatedStudent)
        .then(() => {
            alert('Student updated successfully!');
            loadStudentView(); // Return to the student list view
        })
        .catch((error) => {
            console.error("Error updating student:", error);
            alert('Failed to update student');
        });
}

    function loadCourseView() {
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
                <div class="header">
                    <h2>Manage Course</h2>
                    <button class="add-btn" onclick="showAddCourseForm()">Add New Course</button>
                </div>
                <div class="table-container">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Course Duration</th>
                                <th>Course Type</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="courseTableBody">
                            <!-- Teacher data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            `;
            loadCourseData();
        }
        // Utility functions
        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        function loadCourseData() {
    const courseTableBody = document.getElementById("courseTableBody");
    const courseRef = ref(database, "Courses");

    onValue(courseRef, (snapshot) => {
        courseTableBody.innerHTML = ""; // Clear table before adding new data

        snapshot.forEach((childSnapshot) => {
            const course = childSnapshot.val();
            const courseId = childSnapshot.key; // Get Firebase key

            // Create table row with course details
            const row = `
                <tr>
                    <td>${course.courseName}</td>
                    <td>${course.courseDuration || "N/A"}</td>
                    <td>${course.courseType || "N/A"}</td>
                    <td>
                        <button class="edit-btn" data-id="${courseId}">Edit</button>
                        <button class="delete-btn" data-id="${courseId}">Delete</button>
                    </td>
                </tr>
            `;

            courseTableBody.innerHTML += row;
        });

        // Add event listeners after rows are inserted
        document.querySelectorAll(".edit-btn").forEach((button) => {
            button.addEventListener("click", function () {
                const courseId = this.getAttribute("data-id");
                editCourse(courseId);
            });
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
            button.addEventListener("click", function () {
                const courseId = this.getAttribute("data-id");
                deleteCourse(courseId);
            });
        });
    }, 
    (error) => {
        console.error("Firebase Error:", error.message);
    });
}

    function deleteCourse(courseId) {
        if (confirm('Are you sure you want to delete this course? This will remove all associated data.')) {
            const courseRef = ref(database, `Courses/${courseId}`);
            remove(courseRef)
                .then(() => {
                    // Optional: Remove course references from other related collections
                    const studentsRef = ref(database, "students");
                    const teachersRef = ref(database, "Teachers");

                    // Remove course references from students
                    update(studentsRef, {
                        [courseId]: null
                    });

                    // Remove course references from teachers
                    update(teachersRef, {
                        [courseId]: null
                    });

                    alert('Course deleted successfully!');
                    loadCourseView(); // Refresh the view
                })
                .catch((error) => {
                    console.error("Error deleting course:", error);
                    alert('Failed to delete course');
                });
        }
    }

    // Function to show edit form with current course data
    function editCourse(courseId) {
    const courseRef = ref(database, `Courses/${courseId}`);

    get(courseRef).then((snapshot) => {
        const course = snapshot.val();

        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
            <div class="header">
                <h2>Edit Course</h2>
                <button class="back-btn" onclick="loadCourseView()">Back to List</button>
            </div>
            <div class="form-container">
                <form id="editCourseForm" class="course-form">
                    <div class="form-group">
                        <label for="courseName">Course Name:</label>
                        <input type="text" id="courseName" value="${course.courseName || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="courseDuration">Course Duration:</label>
                        <select id="courseDuration" required>
                            <option value="18 months" ${course.courseDuration === '18 months' ? 'selected' : ''}>18 months</option>
                            <option value="12 months" ${course.courseDuration === '12 months' ? 'selected' : ''}>12 months</option>
                            <option value="06 months" ${course.courseDuration === '06 months' ? 'selected' : ''}>06 months</option>
                            <option value="03 months" ${course.courseDuration === '03 months' ? 'selected' : ''}>03 months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseType">Course Type:</label>
                        <select id="courseType" required>
                            <option value="Full-time" ${course.courseType === 'Full-time' ? 'selected' : ''}>Full-time</option>
                            <option value="Part-time" ${course.courseType === 'Part-time' ? 'selected' : ''}>Part-time</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">Update Course</button>
                </form>
            </div>
        `;

        document.getElementById('editCourseForm').onsubmit = (e) => {
            e.preventDefault();
            updateCourse(courseId);
        };
    }).catch((error) => {
        console.error("Error loading course data:", error);
        alert('Failed to load course data for editing');
    });
}

    // Function to update course data
    function updateCourse(courseId) {
        const updatedCourse = {
            courseName: document.getElementById('courseName').value,
            courseDuration: document.getElementById('courseDuration').value,
            courseType: document.getElementById('courseType').value,
        };

        const courseRef = ref(database, `Courses/${courseId}`);
        
        update(courseRef, updatedCourse)
            .then(() => {
                alert('Course updated successfully!');
                loadCourseView(); // Return to the course list view
            })
            .catch((error) => {
                console.error("Error updating course:", error);
                alert('Failed to update course');
            });
    }
        // Form handlers
        function handleAddAdmin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const adminData = Object.fromEntries(formData.entries());
            
            // Here you would typically send this data to your backend
            console.log('Adding new admin:', adminData);
            
            // Close the modal and refresh the view
            closeModal();
            loadAdminView();
        }

        // Search functionality
        document.querySelector('.search-bar').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
        });
    });

    window.showAddAdminForm = function() {
        showFormModal('Administrator', [
            { type: 'text', name: 'name', label: 'Full Name' },
            { type: 'email', name: 'email', label: 'Email' },
            { type: 'password', name: 'password', label: 'Password' },
            { type: 'select', name: 'role', label: 'Role', options: ['Admin', 'Super Admin'] }
        ], handleAddAdmin);
    }

    window.showAddTeacherForm = function() {
        showFormModal('Teacher', [
            { type: 'text', name: 'name', label: 'Full Name' },
            { type: 'email', name: 'email', label: 'Email' },
            { type: 'text', name: 'department', label: 'Department' },
            { type: 'text', name: 'subject', label: 'Subject' }
        ], handleAddTeacher);
    }

    window.showAddStudentForm = function() {
        showFormModal('Student', [
            { type: 'text', name: 'name', label: 'Full Name' },
            { type: 'email', name: 'email', label: 'Email' },
            { type: 'text', name: 'student_id', label: 'Student ID' },
            { type: 'select', name: 'year', label: 'Year', options: ['Freshman', 'Sophomore', 'Junior', 'Senior'] }
        ], handleAddStudent);
    }

    window.showAddCourseForm = function() {
        showFormModal('Course', [
            { type: 'text', name: 'course_name', label: 'Course Name' },
            { type: 'text', name: 'course_code', label: 'Course Code' },
            { type: 'number', name: 'credits', label: 'Credits' },
            { type: 'text', name: 'instructor', label: 'Instructor' }
        ], handleAddCourse);
    }

    // Generic form modal creator
    function showFormModal(title, fields, submitHandler) {
        const formHTML = `
            <div class="modal">
                <div class="modal-content">
                    <h2>Add New ${title}</h2>
                    <form id="addForm">
                        ${fields.map(field => `
                            <div class="form-group">
                                <label>${field.label}</label>
                                ${field.type === 'select' ? `
                                    <select name="${field.name}" required>
                                        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                    </select>
                                ` : `
                                    <input type="${field.type}" name="${field.name}" required>
                                `}
                            </div>
                        `).join('')}
                        <div class="form-actions">
                            <button type="submit">Add ${title}</button>
                            <button type="button" onclick="closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', formHTML);
        document.getElementById('addForm').addEventListener('submit', submitHandler);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Previous chart and animation code remains the same

        // Update navigation handlers
        function loadAdminView() {
            loadTableView('Administrators', ['ID', 'Name', 'Email', 'Role', 'Status']);
        }

        function loadTeacherView() {
            loadTableView('Teachers', ['ID', 'Name', 'Email', 'Department', 'Subjects']);
        }

        function loadStudentView() {
            loadTableView('Students', ['ID', 'Name', 'Email', 'Student ID', 'Year']);
        }

        function loadCourseView() {
            loadTableView('Courses', ['Code', 'Name', 'Credits', 'Instructor', 'Enrolled']);
        }

        function loadTableView(title, columns) {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h2>Manage ${title}</h2>
                    <button class="add-btn" onclick="showAdd${title.replace(/s$/, '')}Form()">
                        Add New ${title.replace(/s$/, '')}
                    </button>
                </div>
                <div class="table-container">
                    <table class="activity-table">
                        <thead>
                            <tr>${columns.map(col => `<th>${col}</th>`).join('')}<th>Actions</th></tr>
                        </thead>
                        <tbody>
                            <!-- Data would be populated here -->
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Form handlers
        window.handleAddAdmin = function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            console.log('Adding admin:', Object.fromEntries(formData.entries()));
            closeModal();
            loadAdminView();
        }

        window.handleAddTeacher = function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            console.log('Adding teacher:', Object.fromEntries(formData.entries()));
            closeModal();
            loadTeacherView();
        }

        window.handleAddStudent = function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            console.log('Adding student:', Object.fromEntries(formData.entries()));
            closeModal();
            loadStudentView();
        }

        window.handleAddCourse = function(event) {  
            event.preventDefault();
            const formData = new FormData(event.target);
            console.log('Adding course:', Object.fromEntries(formData.entries()));
            closeModal();
            loadCourseView();
        }

        window.closeModal = function() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
    });
</script>
</html>